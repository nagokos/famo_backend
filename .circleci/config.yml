version: 2.1

orbs:
  slack: circleci/slack@4.4.2

jobs:
  build:
    working_directory: ~/repo/api
    docker:
      - image: circleci/ruby:3.0.0-node-browsers
        environment:
          BUNDLER_VERSIONS: 2.2.3
          RAILS_ENV: 'test'
          MYSQL_HOST: 127.0.0.1

      - image: circleci/mysql:8.0
        command: --default-authentication-plugin=mysql_native_password
        environment:
          MYSQL_DATABASE: circle_test
          MYSQL_ROOT_PASSWORD: password

    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-gem-cache-{{ checksum "Gemfile.lock" }}
            - v1-gem-cache-

      - run:
          name: bundle install
          command: |
            gem install bundler -v 2.2.3
            bundle install --jobs=4 --retry=3 --path vendor/bundle

      - save_cache:
         paths:
          - ./vendor/bundle
          - ./node_modules
         key: v1-gem-cache-{{ checksum "Gemfile.lock" }}

      - run: mv config/database.ci.yml config/database.yml
      - run: bundle exec rails db:create
      - run: bundle exec rails db:schema:load

      - run:
          name: Rubocop
          command: bundle exec rubocop

      - run:
          name: rails_best_practices
          command: bundle exec rails_best_practices .

      - run:
          name: Rspec
          command: |
            bundle exec rspec \
              --format progress \
              --format RspecJunitFormatter \
              --out /tmp/test-results/rspec.xml \
              $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)

      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          path: /tmp/test-results
          destination: test-results
      - store_artifacts:
          path: coverage

      - slack/notify: #slacké€šçŸ¥ã®ã‚¹ãƒ†ãƒƒãƒ—åã€‚orbs3ã¯è¨­å®šæ–¹æ³•ãŒå…¨ãç•°ãªã‚‹ã®ã§æ³¨æ„ã€‚
          custom: |
            {
              "text": "",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ‰ğŸ‰ All test suites were passed!",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository*: $CIRCLE_PROJECT_REPONAME"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch*: $CIRCLE_BRANCH"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author*: $CIRCLE_USERNAME"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Job"
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }
          event: pass #circleã®çµæœæŒ‡å®šã€‚failã®å ´åˆã¯å¤±æ•—æ™‚ã€passã¯æˆåŠŸæ™‚ã€‚alwaysã¯çµæœå•ã‚ãšã€‚
          channel: '#circlecié€šçŸ¥'

      - slack/notify: #slacké€šçŸ¥ã®ã‚¹ãƒ†ãƒƒãƒ—åã€‚orbs3ã¯è¨­å®šæ–¹æ³•ãŒå…¨ãç•°ãªã‚‹ã®ã§æ³¨æ„ã€‚
          custom: |
            {
              "text": "",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Test suite failed â—ï¸â—ï¸",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository*: $CIRCLE_PROJECT_REPONAME"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch*: $CIRCLE_BRANCH"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author*: $CIRCLE_USERNAME"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Job"
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }
          event: fail #circleã®çµæœæŒ‡å®šã€‚failã®å ´åˆã¯å¤±æ•—æ™‚ã€passã¯æˆåŠŸæ™‚ã€‚alwaysã¯çµæœå•ã‚ãšã€‚
          channel: '#circlecié€šçŸ¥'